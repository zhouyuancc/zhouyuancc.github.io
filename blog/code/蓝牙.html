<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1404.34">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 32.0px 'Heiti SC Light'; color: #4f81bd}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 16.0px 'STHeiti Light'; color: #595959}
    p.p3 {margin: 0.0px 0.0px 8.0px 0.0px; font: 16.0px Menlo; color: #c41b17}
    p.p4 {margin: 0.0px 0.0px 8.0px 0.0px; font: 16.0px 'STHeiti Light'; color: #0433ff}
    p.p5 {margin: 0.0px 0.0px 8.0px 0.0px; font: 16.0px Menlo; color: #c41b17; min-height: 19.0px}
    p.p6 {margin: 0.0px 0.0px 8.0px 0.0px; font: 16.0px Menlo; color: #ff2500}
    p.p7 {margin: 0.0px 0.0px 8.0px 0.0px; font: 16.0px 'STHeiti Light'; color: #595959}
    p.p8 {margin: 0.0px 0.0px 8.0px 0.0px; font: 16.0px Helvetica; color: #595959}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 16.0px 'STHeiti Light'; color: #595959; min-height: 16.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; background-color: #ffb5af}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; color: #1d9421}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; min-height: 21.0px}
    p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; color: #c91b13}
    p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo}
    p.p15 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px 'Heiti SC Light'; color: #1d9421}
    p.p16 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; color: #c32275}
    p.p17 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; color: #822e0e}
    p.p18 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; color: #6122ae}
    p.p19 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; color: #3d1d81}
    p.p20 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Menlo; color: #539aa4}
    span.s1 {font: 32.0px Helvetica; font-kerning: none; font-variant-ligatures: no-common-ligatures}
    span.s2 {font-kerning: none; font-variant-ligatures: no-common-ligatures}
    span.s3 {font: 16.0px Helvetica; font-kerning: none; font-variant-ligatures: no-common-ligatures}
    span.s4 {font-kerning: none; font-variant-ligatures: no-common-ligatures; background-color: #ffb5af}
    span.s5 {font: 16.0px 'STHeiti Light'; font-kerning: none; font-variant-ligatures: no-common-ligatures; color: #ff2500}
    span.s6 {font-kerning: none; font-variant-ligatures: no-common-ligatures; color: #595959}
    span.s7 {font: 16.0px 'STHeiti Light'; font-kerning: none; font-variant-ligatures: no-common-ligatures}
    span.s8 {font: 16.0px Helvetica; font-kerning: none; font-variant-ligatures: no-common-ligatures; color: #595959}
    span.s9 {font: 16.0px 'STHeiti Light'; font-kerning: none; font-variant-ligatures: no-common-ligatures; background-color: #ffdad8}
    span.s10 {font-kerning: none; font-variant-ligatures: no-common-ligatures; background-color: #ffdad8}
    span.s11 {font-variant-ligatures: no-common-ligatures}
    span.s12 {font: 18.0px 'Heiti SC Light'; font-variant-ligatures: no-common-ligatures}
    span.s13 {font-variant-ligatures: no-common-ligatures; background-color: #ffb5af}
    span.s14 {font-variant-ligatures: no-common-ligatures; color: #822e0e}
    span.s15 {font-variant-ligatures: no-common-ligatures; color: #c32275}
    span.s16 {font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures}
    span.s17 {font-variant-ligatures: no-common-ligatures; color: #000000}
    span.s18 {font: 18.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #000000}
    span.s19 {font-variant-ligatures: no-common-ligatures; color: #1d9421}
    span.s20 {font-variant-ligatures: no-common-ligatures; color: #0435ff}
    span.s21 {font-variant-ligatures: no-common-ligatures; color: #3c828c}
    span.s22 {font-variant-ligatures: no-common-ligatures; color: #6122ae}
    span.s23 {font-variant-ligatures: no-common-ligatures; color: #539aa4}
    span.s24 {font-variant-ligatures: no-common-ligatures; color: #3d1d81}
    span.s25 {font-variant-ligatures: no-common-ligatures; color: #703daa}
    span.s26 {font-variant-ligatures: no-common-ligatures; color: #c91b13}
  </style>
</head>
<body>
<p class="p1"><span class="s1">iOS</span><span class="s2">中蓝牙的实现方案</span></p>
<p class="p2"><span class="s3">iOS</span><span class="s2">中提供了</span><span class="s3">4</span><span class="s2">个框架用于实现蓝牙连接</span></p>
<p class="p3"><span class="s4">GameKit.framework</span><span class="s5">（用法简单）</span></p>
<p class="p4"><span class="s2">只能用于</span><span class="s3">iOS</span><span class="s2">设备之间的连接</span><span class="s6">，多用于游戏（比如五子棋对战），</span><span class="s2">从</span><span class="s3">iOS7</span><span class="s2">开始过期</span></p>
<p class="p5"><span class="s2"></span><br></p>
<p class="p3"><span class="s2">MultipeerConnectivity.framework</span></p>
<p class="p4"><span class="s2">只能用于</span><span class="s3">iOS</span><span class="s2">设备之间的连接</span><span class="s6">，</span><span class="s2">从</span><span class="s3">iOS7</span><span class="s2">开始引入</span><span class="s6">，主要用于文件共享（仅限于沙盒的文件）</span></p>
<p class="p5"><span class="s2"></span><br></p>
<p class="p3"><span class="s2">ExternalAccessory.framework</span></p>
<p class="p4"><span class="s2">可用于第三方蓝牙设备交互</span><span class="s6">，但是蓝牙设备必须经过</span><span class="s2">苹果</span><span class="s3">MFi</span><span class="s2">认证</span><span class="s6">（国内较少）</span></p>
<p class="p5"><span class="s2"></span><br></p>
<p class="p6"><span class="s4">CoreBluetooth.framework</span><span class="s7">（时下热门）</span></p>
<p class="p4"><span class="s2">可用于第三方蓝牙设备交互</span><span class="s6">，必须要支持蓝牙</span><span class="s8">4.0</span></p>
<p class="p7"><span class="s2">硬件至少是</span><span class="s3">4s</span><span class="s2">，系统至少是</span><span class="s3">iOS6</span></p>
<p class="p8"><span class="s7">蓝牙</span><span class="s2">4.0</span><span class="s7">以</span><span class="s9">低功耗</span><span class="s7">著称，一般也叫</span><span class="s2">BLE</span><span class="s7">（</span><span class="s2">Bluetooth</span><span class="s10"> Low Energy</span><span class="s7">）</span></p>
<p class="p2"><span class="s2">目前应用比较多的案例：运动手坏、智能家居、嵌入式设备等（金融刷卡器、心电测量器）</span></p>
<p class="p9"><span class="s2"></span><br></p>
<p class="p2"><span class="s2">模拟器测试</span></p>
<p class="p7"><span class="s2">1.买一个</span><span class="s3">CSR</span><span class="s2">蓝牙</span><span class="s3">4.0 USB</span><span class="s2">适配器，插在</span><span class="s3">Mac</span><span class="s2">上</span></p>
<p class="p8"><span class="s7">2.在终端输入</span><span class="s2">sudo nvram bluetoothHostControllerSwitchBehavior="never"</span></p>
<p class="p7"><span class="s2">3.重启</span><span class="s3">Mac</span></p>
<p class="p7"><span class="s2">4.用</span><span class="s3">Xcode 4.6</span><span class="s2">调试代码，将程序跑在</span><span class="s3">iOS 6.1</span><span class="s2">的模拟器上（苹果把</span><span class="s3">iOS 7.0</span><span class="s2">模拟器对</span><span class="s3">BLE</span><span class="s2">的支持移除掉了）</span></p>
<p class="p10"><span class="s11">———————————————————————————————————————————————————————————————————————————————————————————————</span></p>
<p class="p11"><span class="s11">//</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>ViewController.m</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>06-</span><span class="s12">蓝牙</span><span class="s11">(</span><span class="s13">GameKit</span><span class="s11">)</span></p>
<p class="p11"><span class="s11">//</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>Created by apple on 15/2/9.</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>Copyright (c) 2015</span><span class="s12">年</span><span class="s11"> apple. All rights reserved.</span></p>
<p class="p11"><span class="s11">//</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p13"><span class="s14">#import </span><span class="s11">"ViewController.h"</span></p>
<p class="p13"><span class="s14">#import </span><span class="s11">&lt;GameKit/GameKit.h&gt;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p14"><span class="s15">@interface</span><span class="s11"> ViewController () &lt;UINavigationControllerDelegate, UIImagePickerControllerDelegate, GKPeerPickerControllerDelegate&gt;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p11"><span class="s11">// </span><span class="s12">显示照片的</span><span class="s11">View</span></p>
<p class="p14"><span class="s15">@property</span><span class="s11"> (</span><span class="s15">weak</span><span class="s11">, </span><span class="s15">nonatomic</span><span class="s11">) </span><span class="s15">IBOutlet</span><span class="s11"> UIImageView *imageView;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p15"><span class="s16">// </span><span class="s11">保留会话用户发送数据</span></p>
<p class="p16"><span class="s11">@property</span><span class="s17">(</span><span class="s11">nonatomic</span><span class="s17">,</span><span class="s11">strong</span><span class="s17">)GKSession *session;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s12">连接设备</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">IBAction</span><span class="s11">)connectDevice;</span></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s12">选择照片</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">IBAction</span><span class="s11">)pickImage;</span></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s12">发送照片</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">IBAction</span><span class="s11">)sendImage;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p16"><span class="s11">@end</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p14"><span class="s15">@implementation</span><span class="s11"> ViewController</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)viewDidLoad {</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[</span><span class="s15">super</span><span class="s11"> viewDidLoad];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - </span><span class="s12">连接设备</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">IBAction</span><span class="s11">)connectDevice {</span></p>
<p class="p15"><span class="s18"><span class="Apple-converted-space">    </span></span><span class="s16">// 1.</span><span class="s11">创建查找设备的控制器</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>GKPeerPickerController *ppc = [[GKPeerPickerController alloc] init];</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 2.</span><span class="s12">设置代理</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>ppc.delegate = </span><span class="s15">self</span><span class="s11">;</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 3.</span><span class="s12">弹出控制器</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[ppc show];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">设备连接成功后会调用该方法</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param peerID<span class="Apple-converted-space">  </span></span><span class="s12">设备节点</span><span class="s11">ID</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param session </span><span class="s12">会话</span><span class="s11">(</span><span class="s12">使用该会话对象来相互传递数据</span><span class="s11">)</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)peerPickerController:(GKPeerPickerController *)picker didConnectPeer:(NSString *)peerID toSession:(GKSession *)session</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 1.</span><span class="s12">保留会话</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">self</span><span class="s11">.session = session;</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 2.</span><span class="s12">设置数据接受者</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[</span><span class="s15">self</span><span class="s11">.session setDataReceiveHandler:</span><span class="s15">self</span><span class="s11"> withContext:</span><span class="s15">nil</span><span class="s11">];</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p15"><span class="s18"><span class="Apple-converted-space">    </span></span><span class="s16">// 2.</span><span class="s11">退出查找设备的控制器</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[picker dismiss];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - </span><span class="s12">选择照片</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">IBAction</span><span class="s11">)pickImage {</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 1.</span><span class="s12">判断照片源是否可用</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s19">/*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space">     </span>UIImagePickerControllerSourceTypePhotoLibrary </span><span class="s12">图片库</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space">     </span>UIImagePickerControllerSourceTypeCamera </span><span class="s12">相机</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space">     </span>UIImagePickerControllerSourceTypeSavedPhotosAlbum </span><span class="s12">相册</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space">     </span>*/</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">if</span><span class="s11"> (![UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeSavedPhotosAlbum]) </span><span class="s15">return</span><span class="s11">;</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 2.</span><span class="s12">创建照片选择控制器</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>UIImagePickerController *ipc = [[UIImagePickerController alloc] init];</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 3.</span><span class="s12">设置照片源</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>ipc.sourceType = UIImagePickerControllerSourceTypeSavedPhotosAlbum;</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 4.</span><span class="s12">设置代理</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>ipc.delegate = </span><span class="s15">self</span><span class="s11">;</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 5.</span><span class="s12">弹出控制器</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[</span><span class="s15">self</span><span class="s11"> presentViewController:ipc animated:</span><span class="s15">YES</span><span class="s11"> completion:</span><span class="s15">nil</span><span class="s11">];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">当选中某一个照片的时候会调用该方法</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param info <span class="Apple-converted-space">  </span></span><span class="s12">存放着照片信息</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 1.</span><span class="s12">取出照片</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">self</span><span class="s11">.imageView.image = info[UIImagePickerControllerOriginalImage];</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 2.</span><span class="s12">退出控制器</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[picker dismissViewControllerAnimated:</span><span class="s15">YES</span><span class="s11"> completion:</span><span class="s15">nil</span><span class="s11">];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - </span><span class="s12">发送照片</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">IBAction</span><span class="s11">)sendImage {</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 0.</span><span class="s12">判断</span><span class="s11">image</span><span class="s12">如果为空直接返回</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">if</span><span class="s11"> (!</span><span class="s15">self</span><span class="s11">.imageView.image) </span><span class="s15">return</span><span class="s11">;</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 1.</span><span class="s12">将</span><span class="s11">UIImage</span><span class="s12">转化成</span><span class="s11">NSData</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// UIImagePNGRepresentation(UIImage *image)</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// </span><span class="s12">压缩</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>NSData *imageData = UIImageJPEGRepresentation(</span><span class="s15">self</span><span class="s11">.imageView.image, </span><span class="s20">0.5</span><span class="s11">);</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// self.session sendData:(NSData *) toPeers:(NSArray *) withDataMode:(GKSendDataMode) error:(NSError *__autoreleasing *)</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 2.</span><span class="s12">发送照片</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s19">/*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space">     </span>GKSendDataReliable,<span class="Apple-converted-space">        </span></span><span class="s12">可靠传输</span><span class="s11">(</span><span class="s12">数据一定会被传达</span><span class="s11">,</span><span class="s12">如果中间网络发生状况</span><span class="s11">,</span><span class="s12">重新连接</span><span class="s11">,</span><span class="s12">再次传输</span><span class="s11">)--&gt;TCP</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space">     </span>GKSendDataUnreliable,<span class="Apple-converted-space">      </span></span><span class="s12">不可靠传输</span><span class="s11">(</span><span class="s12">数据只会发送一次</span><span class="s11">,</span><span class="s12">没有收到就算了</span><span class="s11">)--&gt;UDP</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space">     </span>*/</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">//peer </span><span class="s12">连接上的设备</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[</span><span class="s15">self</span><span class="s11">.session sendDataToAllPeers:imageData withDataMode:GKSendDataReliable error:</span><span class="s15">nil</span><span class="s11">];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - </span><span class="s12">接受数据</span></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">当接受收到数据的时候会调用该方法</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param data<span class="Apple-converted-space">    </span></span><span class="s12">接受到的数据</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param peer<span class="Apple-converted-space">    </span></span><span class="s12">从哪一个节点接受到的数据</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param session </span><span class="s12">会话</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">) receiveData:(NSData *)data fromPeer:(NSString *)peer inSession: (GKSession *)session context:(</span><span class="s15">void</span><span class="s11"> *)context</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 1.</span><span class="s12">将</span><span class="s11">NSData</span><span class="s12">转化成</span><span class="s11">UIImage</span><span class="s12">对象</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>UIImage *receiveImage = [UIImage imageWithData:data];</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 2.</span><span class="s12">设置到</span><span class="s11">imageView</span><span class="s12">上</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">self</span><span class="s11">.imageView.image = receiveImage;</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p15"><span class="s18"><span class="Apple-converted-space">    </span></span><span class="s16">// 3.</span><span class="s11">将图片保存到相册当中</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>UIImageWriteToSavedPhotosAlbum(receiveImage, </span><span class="s15">nil</span><span class="s11">, </span><span class="s15">nil</span><span class="s11">, </span><span class="s15">nil</span><span class="s11">);</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p16"><span class="s11">@end</span></p>
<p class="p10"><span class="s11">———————————————————————————————————————————————————————————————————————————————————————————————</span></p>
<p class="p11"><span class="s11">//</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>ViewController.m</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>07-</span><span class="s12">蓝牙</span><span class="s11">(CoreBlooth)</span></p>
<p class="p11"><span class="s11">//</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>Created by apple on 15/2/9.</span></p>
<p class="p11"><span class="s11">//<span class="Apple-converted-space">  </span>Copyright (c) 2015</span><span class="s12">年</span><span class="s11"> apple. All rights reserved.</span></p>
<p class="p11"><span class="s11">//</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p13"><span class="s14">#import </span><span class="s11">"ViewController.h"</span></p>
<p class="p13"><span class="s14">#import </span><span class="s11">&lt;CoreBluetooth/CoreBluetooth.h&gt;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p18"><span class="s15">@interface</span><span class="s17"> </span><span class="s21">ViewController</span><span class="s17"> () &lt;</span><span class="s11">CBCentralManagerDelegate</span><span class="s17">, </span><span class="s11">CBPeripheralDelegate</span><span class="s17">&gt;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p15"><span class="s16">// </span><span class="s11">中央管理者</span></p>
<p class="p16"><span class="s11">@property</span><span class="s17">(</span><span class="s11">nonatomic</span><span class="s17">,</span><span class="s11">strong</span><span class="s17">)</span><span class="s22">CBCentralManager</span><span class="s17"> *mgr;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p16"><span class="s11">@property</span><span class="s17">(</span><span class="s11">nonatomic</span><span class="s17">,</span><span class="s11">strong</span><span class="s17">)</span><span class="s22">NSMutableArray</span><span class="s17"> *peripherals;</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p16"><span class="s11">@end</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p14"><span class="s15">@implementation</span><span class="s11"> ViewController</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)viewDidLoad {</span></p>
<p class="p19"><span class="s17"><span class="Apple-converted-space">    </span>[</span><span class="s15">super</span><span class="s17"> </span><span class="s11">viewDidLoad</span><span class="s17">];</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 1.</span><span class="s12">扫描所有的外围设备</span></p>
<p class="p15"><span class="s18"><span class="Apple-converted-space">    </span></span><span class="s16">// serviceUUIDs:</span><span class="s11">可以将你想要扫描的服务的外围设备传入</span><span class="s16">(</span><span class="s11">传</span><span class="s16">nil,</span><span class="s11">扫描所有的外围设备</span><span class="s16">)</span></p>
<p class="p19"><span class="s17"><span class="Apple-converted-space">    </span>[</span><span class="s15">self</span><span class="s17">.</span><span class="s23">mgr</span><span class="s17"> </span><span class="s11">scanForPeripheralsWithServices</span><span class="s17">:</span><span class="s15">nil</span><span class="s17"> </span><span class="s11">options</span><span class="s17">:</span><span class="s15">nil</span><span class="s17">];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - CBCentralManager</span><span class="s12">的代理方法</span></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">状态发生改变的时候会执行该方法</span><span class="s16">(</span><span class="s11">蓝牙</span><span class="s16">4.0</span><span class="s11">没有打开变成打开状态就会调用该方法</span><span class="s16">)</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)centralManagerDidUpdateState:(</span><span class="s22">CBCentralManager</span><span class="s11"> *)central</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">当发现外围设备的时候会调用该方法</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param peripheral<span class="Apple-converted-space">        </span></span><span class="s12">发现的外围设备</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param advertisementData </span><span class="s12">外围设备发出信号</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param RSSI<span class="Apple-converted-space">              </span></span><span class="s12">信号强度</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)centralManager:(</span><span class="s22">CBCentralManager</span><span class="s11"> *)central didDiscoverPeripheral:(</span><span class="s22">CBPeripheral</span><span class="s11"> *)peripheral advertisementData:(</span><span class="s22">NSDictionary</span><span class="s11"> *)advertisementData RSSI:(</span><span class="s22">NSNumber</span><span class="s11"> *)RSSI</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">if</span><span class="s11"> (![</span><span class="s15">self</span><span class="s11">.</span><span class="s23">peripherals</span><span class="s11"> </span><span class="s24">containsObject</span><span class="s11">:peripheral]) {</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span>[</span><span class="s15">self</span><span class="s11">.</span><span class="s23">peripherals</span><span class="s11"> </span><span class="s24">addObject</span><span class="s11">:peripheral];</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">连接上外围设备的时候会调用该方法</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param peripheral </span><span class="s12">连接上的外围设备</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)centralManager:(</span><span class="s22">CBCentralManager</span><span class="s11"> *)central didConnectPeripheral:(</span><span class="s22">CBPeripheral</span><span class="s11"> *)peripheral</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 1.</span><span class="s12">扫描所有的服务</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// serviceUUIDs:</span><span class="s12">指定要扫描该外围设备的哪些服务</span><span class="s11">(</span><span class="s12">传</span><span class="s11">nil,</span><span class="s12">扫描所有的服务</span><span class="s11">)</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>[peripheral </span><span class="s24">discoverServices</span><span class="s11">:</span><span class="s15">nil</span><span class="s11">];</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">    </span></span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// 2.</span><span class="s12">设置代理</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>peripheral.</span><span class="s25">delegate</span><span class="s11"> = </span><span class="s15">self</span><span class="s11">;</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - CBPeripheral</span><span class="s12">的代理方法</span></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">发现外围设备的服务会来到该方法</span><span class="s16">(</span><span class="s11">扫描到服务之后直接添加</span><span class="s16">peripheral</span><span class="s11">的</span><span class="s16">services)</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)peripheral:(</span><span class="s22">CBPeripheral</span><span class="s11"> *)peripheral didDiscoverServices:(</span><span class="s22">NSError</span><span class="s11"> *)error</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">for</span><span class="s11"> (</span><span class="s22">CBService</span><span class="s11"> *serivce </span><span class="s15">in</span><span class="s11"> peripheral.</span><span class="s25">services</span><span class="s11">) {</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span></span><span class="s15">if</span><span class="s11"> ([serivce.</span><span class="s25">UUID</span><span class="s11">.</span><span class="s25">UUIDString</span><span class="s11"> </span><span class="s24">isEqualToString</span><span class="s11">:</span><span class="s26">@"123"</span><span class="s11">]) {</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">            </span></span><span class="s11">// characteristicUUIDs : </span><span class="s12">可以指定想要扫描的特征</span><span class="s11">(</span><span class="s12">传</span><span class="s11">nil,</span><span class="s12">扫描所有的特征</span><span class="s11">)</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">            </span>[peripheral </span><span class="s24">discoverCharacteristics</span><span class="s11">:</span><span class="s15">nil</span><span class="s11"> </span><span class="s24">forService</span><span class="s11">:serivce];</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p11"><span class="s11">/**</span></p>
<p class="p15"><span class="s16"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span></span><span class="s11">当扫描到某一个服务的特征的时候会调用该方法</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*<span class="Apple-converted-space">  </span>@param service<span class="Apple-converted-space">    </span></span><span class="s12">在哪一个服务里面的特征</span></p>
<p class="p11"><span class="s11"><span class="Apple-converted-space"> </span>*/</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)peripheral:(</span><span class="s22">CBPeripheral</span><span class="s11"> *)peripheral didDiscoverCharacteristicsForService:(</span><span class="s22">CBService</span><span class="s11"> *)service error:(</span><span class="s22">NSError</span><span class="s11"> *)error</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">for</span><span class="s11"> (</span><span class="s22">CBCharacteristic</span><span class="s11"> *characteristic </span><span class="s15">in</span><span class="s11"> service.</span><span class="s25">characteristics</span><span class="s11">) {</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span></span><span class="s15">if</span><span class="s11"> ([characteristic.</span><span class="s25">UUID</span><span class="s11">.</span><span class="s25">UUIDString</span><span class="s11"> </span><span class="s24">isEqualToString</span><span class="s11">:</span><span class="s26">@"456"</span><span class="s11">]) {</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">            </span></span><span class="s11">// </span><span class="s12">拿到特征</span><span class="s11">,</span><span class="s12">和外围设备进行交互</span></p>
<p class="p12"><span class="s11"><span class="Apple-converted-space">            </span></span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - </span><span class="s12">连接设备</span></p>
<p class="p14"><span class="s11">- (</span><span class="s15">void</span><span class="s11">)connect:(</span><span class="s22">CBPeripheral</span><span class="s11"> *)peripheral</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p11"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s11">// </span><span class="s12">连接外围设备</span></p>
<p class="p19"><span class="s17"><span class="Apple-converted-space">    </span>[</span><span class="s15">self</span><span class="s17">.</span><span class="s23">mgr</span><span class="s17"> </span><span class="s11">connectPeripheral</span><span class="s17">:peripheral </span><span class="s11">options</span><span class="s17">:</span><span class="s15">nil</span><span class="s17">];</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p17"><span class="s11">#pragma mark - </span><span class="s12">懒加载代码</span></p>
<p class="p18"><span class="s17">- (</span><span class="s11">CBCentralManager</span><span class="s17"> *)mgr</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">if</span><span class="s11"> (</span><span class="s23">_mgr</span><span class="s11"> == </span><span class="s15">nil</span><span class="s11">) {</span></p>
<p class="p19"><span class="s17"><span class="Apple-converted-space">        </span></span><span class="s23">_mgr</span><span class="s17"> = [[</span><span class="s22">CBCentralManager</span><span class="s17"> </span><span class="s11">alloc</span><span class="s17">] </span><span class="s11">initWithDelegate</span><span class="s17">:</span><span class="s15">self</span><span class="s17"> </span><span class="s11">queue</span><span class="s17">:</span><span class="s15">nil</span><span class="s17">];</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">return</span><span class="s11"> </span><span class="s23">_mgr</span><span class="s11">;</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p14"><span class="s11">- (</span><span class="s22">NSMutableArray</span><span class="s11"> *)peripherals</span></p>
<p class="p14"><span class="s11">{</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span></span><span class="s15">if</span><span class="s11"> (</span><span class="s23">_peripherals</span><span class="s11"> == </span><span class="s15">nil</span><span class="s11">) {</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span></span><span class="s23">_peripherals</span><span class="s11"> = [</span><span class="s22">NSMutableArray</span><span class="s11"> </span><span class="s24">array</span><span class="s11">];</span></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p20"><span class="s17"><span class="Apple-converted-space">    </span></span><span class="s15">return</span><span class="s17"> </span><span class="s11">_peripherals</span><span class="s17">;</span></p>
<p class="p14"><span class="s11">}</span></p>
<p class="p12"><span class="s11"></span><br></p>
<p class="p16"><span class="s11">@end</span></p>
</body>
</html>
